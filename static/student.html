<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebClass — Ученик</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at center, #001830, #000714 80%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
      padding: 20px;
    }

    h2 {
      margin-bottom: 10px;
      font-size: 22px;
      font-weight: 600;
      text-align: center;
    }

    .container {
      display: flex;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }

    .column {
      width: 28vw;
      min-width: 300px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 15px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .video-box {
      width: 100%;
      aspect-ratio: 9/16;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .messages {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
      overflow-y: auto;
      font-size: 15px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 15px;
    }

    button {
      background: #18c964;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #000;
    }

  </style>
</head>

<body>

  <div class="container">

    <!-- Ученик -->
    <div class="column">
      <h2>Вы (ученик)</h2>
      <div class="video-box">
        <video id="studentLocal" autoplay muted playsinline></video>
      </div>
    </div>

    <!-- Чат -->
    <div class="column">
      <h2>Чат</h2>
      <div class="chat">
        <div id="messages" class="messages">Пока сообщений нет.</div>
        <div class="input-row">
          <input id="msgInput" type="text" placeholder="Введите сообщение...">
          <button onclick="sendMessage()">OK</button>
        </div>
      </div>
    </div>

    <!-- Учитель -->
    <div class="column">
      <h2>Учитель</h2>
      <div class="video-box">
        <video id="teacherRemote" autoplay playsinline></video>
      </div>
    </div>

  </div>

<script>

///////////////////////////////////////////////////////////////////////////////
// 1. ПАРАМЕТРЫ
///////////////////////////////////////////////////////////////////////////////

const params = new URLSearchParams(window.location.search);
const room = params.get("room") || "room1";
const teacherName = params.get("teacher") || "Учитель";


///////////////////////////////////////////////////////////////////////////////
// 2. ВИДЕО ЛОКАЛЬНОЕ УЧЕНИКА
///////////////////////////////////////////////////////////////////////////////

let localStream = null;
const studentLocal = document.getElementById("studentLocal");

async function startLocal() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    studentLocal.srcObject = localStream;
  } catch (err) {
    alert("Нет доступа к камере/микрофону");
    console.error(err);
  }
}

startLocal();


///////////////////////////////////////////////////////////////////////////////
// 3. WebSocket + WebRTC
///////////////////////////////////////////////////////////////////////////////

const wsProto = location.protocol === "https:" ? "wss" : "ws";
const wsURL = `${wsProto}://${location.host}/ws?room=${encodeURIComponent(room)}&role=student`;
const ws = new WebSocket(wsURL);

let pc = null;
const teacherRemote = document.getElementById("teacherRemote");

function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  // локальные треки -> учителю
  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
  });

  // удалённый поток учителя
  pc.ontrack = (event) => {
    teacherRemote.srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(JSON.stringify({
        type: "ice-candidate",
        candidate: event.candidate
      }));
    }
  };
}


ws.onmessage = async (ev) => {
  const msg = JSON.parse(ev.data);

  if (msg.type === "offer") {
    createPeerConnection();

    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({
      type: "answer",
      sdp: pc.localDescription
    }));
  }

  if (msg.type === "ice-candidate") {
    if (pc && msg.candidate) {
      try {
        await pc.addIceCandidate(msg.candidate);
      } catch (err) {
        console.error("ICE error", err);
      }
    }
  }
};


///////////////////////////////////////////////////////////////////////////////
// 4. ЧАТ
///////////////////////////////////////////////////////////////////////////////

function sendMessage() {
  const box = document.getElementById("msgInput");
  const msg = box.value.trim();
  if (!msg) return;

  const container = document.getElementById("messages");
  if (container.textContent === "Пока сообщений нет.") container.innerHTML = "";

  const div = document.createElement("div");
  div.textContent = "Вы: " + msg;
  container.appendChild(div);

  box.value = "";
}

</script>

</body>
</html>
