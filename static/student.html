<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebClass ‚Äî –£—á–µ–Ω–∏–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at center, #001830, #000714 80%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
      padding: 20px;
    }

    h2 {
      font-weight: 600;
      text-align: center;
      font-size: 20px;
      margin-bottom: 4px;
    }

    .top-info {
      margin-bottom: 16px;
      font-size: 14px;
      opacity: 0.9;
    }

    .container {
      display: flex;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }

    .column {
      width: 28vw;
      min-width: 300px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 15px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .video-box {
      width: 100%;
      aspect-ratio: 9 / 16;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }

    .chat {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .messages {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 10px;
      overflow-y: auto;
      font-size: 15px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 15px;
    }

    .btn {
      background: #18c964;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #000;
    }

    .attachments-hint {
      font-size: 12px;
      opacity: 0.7;
    }

  </style>
</head>

<body>

  <div class="top-info">
    –ö–æ–º–Ω–∞—Ç–∞: <strong id="roomLabel"></strong>,
    —É—á–∏—Ç–µ–ª—å: <strong id="teacherLabel"></strong>
  </div>

  <div class="container">

    <!-- –£—á–µ–Ω–∏–∫ –ª–æ–∫–∞–ª—å–Ω–æ -->
    <div class="column">
      <h2>–í—ã (—É—á–µ–Ω–∏–∫)</h2>
      <div id="studentBox" class="video-box">
        <video id="studentLocal" autoplay muted playsinline></video>
        <div class="video-controls">
          <button class="icon-btn" id="localMuteBtn" title="–í—ã–∫–ª/–≤–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">üîá</button>
          <button class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω" onclick="toggleFullscreen('studentBox')">‚õ∂</button>
        </div>
      </div>
    </div>

    <!-- –ß–∞—Ç -->
    <div class="column">
      <h2>–ß–∞—Ç</h2>
      <div class="chat">
        <div id="messages" class="messages">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.</div>
        <div class="input-row">
          <input id="msgInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
          <button class="btn" onclick="sendMessage()">OK</button>
        </div>
        <div class="attachments-hint">
          –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ 10 –ú–ë (PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.
        </div>
      </div>
    </div>

    <!-- –£—á–∏—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω–Ω—ã–π -->
    <div class="column">
      <h2>–£—á–∏—Ç–µ–ª—å</h2>
      <div id="teacherBox" class="video-box">
        <video id="teacherRemote" autoplay playsinline></video>
        <div class="video-controls">
          <button class="icon-btn" id="remoteMuteBtn" title="–í—ã–∫–ª/–≤–∫–ª –∑–≤—É–∫">üîà</button>
          <button class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω" onclick="toggleFullscreen('teacherBox')">‚õ∂</button>
        </div>
      </div>
    </div>

  </div>

<script>
////////////////////////////////////////////////////////////////////////////////
// –ü–ê–†–ê–ú–ï–¢–†–´
////////////////////////////////////////////////////////////////////////////////
const params = new URLSearchParams(window.location.search);
const room = params.get("room") || "room1";
const teacherName = params.get("teacher") || "–£—á–∏—Ç–µ–ª—å";

document.getElementById("roomLabel").textContent = room;
document.getElementById("teacherLabel").textContent = teacherName;

////////////////////////////////////////////////////////////////////////////////
// –õ–û–ö–ê–õ–¨–ù–û–ï –í–ò–î–ï–û
////////////////////////////////////////////////////////////////////////////////
let localStream = null;
const studentLocal = document.getElementById("studentLocal");
const localMuteBtn = document.getElementById("localMuteBtn");
let micMuted = false;

async function startLocal() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    studentLocal.srcObject = localStream;
  } catch (err) {
    console.error(err);
    alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
  }
}
startLocal();

localMuteBtn.addEventListener("click", () => {
  if (!localStream) return;
  micMuted = !micMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !micMuted);
  localMuteBtn.textContent = micMuted ? "üîà" : "üîá";
});

function toggleFullscreen(boxId) {
  const el = document.getElementById(boxId);
  if (!el) return;
  if (document.fullscreenElement) {
    document.exitFullscreen().catch(() => {});
  } else {
    el.requestFullscreen().catch(() => {});
  }
}

////////////////////////////////////////////////////////////////////////////////
// WebRTC + WebSocket
////////////////////////////////////////////////////////////////////////////////
const wsProto = location.protocol === "https:" ? "wss" : "ws";
const wsURL = "wss://webclass-backend-g3uh.onrender.com/ws";
const ws = new WebSocket(wsURL);

let pc = null;
const teacherRemote = document.getElementById("teacherRemote");
const remoteMuteBtn = document.getElementById("remoteMuteBtn");
let remoteMuted = false;

remoteMuteBtn.addEventListener("click", () => {
  if (!teacherRemote) return;
  remoteMuted = !remoteMuted;
  teacherRemote.muted = remoteMuted;
  remoteMuteBtn.textContent = remoteMuted ? "üîá" : "üîà";
});

function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  if (localStream) {
    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
    });
  }

  pc.ontrack = (event) => {
    teacherRemote.srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(JSON.stringify({
        type: "ice-candidate",
        candidate: event.candidate
      }));
    }
  };
}

ws.onmessage = async (ev) => {
  const msg = JSON.parse(ev.data);

  if (msg.type === "offer") {
    if (!pc) createPeerConnection();

    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({
      type: "answer",
      sdp: pc.localDescription
    }));
  }

  if (msg.type === "ice-candidate" && pc && msg.candidate) {
    try {
      await pc.addIceCandidate(msg.candidate);
    } catch (err) {
      console.error("ICE error", err);
    }
  }
};

////////////////////////////////////////////////////////////////////////////////
// –ß–ê–¢ (–ª–æ–∫–∞–ª—å–Ω—ã–π UI)
////////////////////////////////////////////////////////////////////////////////
function sendMessage() {
  const box = document.getElementById("msgInput");
  const text = box.value.trim();
  if (!text) return;

  const container = document.getElementById("messages");
  if (container.textContent === "–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.") container.innerHTML = "";

  const div = document.createElement("div");
  div.textContent = "–í—ã: " + text;
  container.appendChild(div);

  box.value = "";
}
</script>

</body>
</html>
