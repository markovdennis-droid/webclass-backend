<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebClass ‚Äî –ö–æ–º–Ω–∞—Ç–∞ —É—á–µ–Ω–∏–∫–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-grad: linear-gradient(145deg, #020617 0%, #0b1635 45%, #020617 100%);
            --panel: rgba(15,23,42,0.96);
            --panel-soft: rgba(15,23,42,0.9);
            --border: #1e293b;
            --accent: #4f46e5;
            --accent-soft: rgba(79,70,229,0.2);
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
        }
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-grad);
            background-attachment: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
        }
        .card {
            background: radial-gradient(circle at top left, #020617 0%, #020617 55%, #000 100%);
            backdrop-filter: blur(18px);
            padding: 20px 22px 24px;
            border-radius: 22px;
            width: 1400px;
            max-width: 98vw;
            border: 1px solid rgba(148,163,184,0.25);
            box-shadow: 0 24px 55px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .top-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: baseline;
        }
        h2 {
            margin: 0;
            font-size: 20px;
        }
        .room {
            font-size: 13px;
            color: var(--text-muted);
        }
        .bottom-row {
            display: grid;
            grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.3fr) minmax(0, 1.35fr);
            gap: 14px;
            align-items: stretch;
        }
        .video-column {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
            min-height: 340px;
        }
        .video-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        .video-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .viewport {
            flex: 1;
            border-radius: 14px;
            background: radial-gradient(circle at top, #020617 0%, #000 100%);
            border: 1px solid rgba(30,64,175,0.7);
            position: relative;
            overflow: hidden;
            aspect-ratio: 9 / 16;
            align-self: stretch;
            width: 100%;
        }
        .viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            display: block;
        }
        .video-toolbar {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            z-index: 10;
        }
        .icon-btn {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.45);
            background: rgba(15,23,42,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
        }
        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--text-main);
        }
        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 0 12px;
            pointer-events: none;
        }
        .video-placeholder b {
            font-size: 16px;
            color: var(--text-main);
        }

        /* –ß–ê–¢ –ü–û –°–ï–†–ï–î–ò–ù–ï */
        .chat-panel {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            min-height: 340px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .chat-title {
            font-size: 14px;
            font-weight: 500;
        }
        .chat-status {
            font-size: 11px;
            color: var(--text-muted);
        }
        .chat-messages {
            flex: 1;
            background: #020617;
            border-radius: 10px;
            border: 1px solid #111827;
            padding: 8px;
            overflow-y: auto;
            font-size: 13px;
            margin-bottom: 6px;
        }
        .chat-empty {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 18px;
        }
        .chat-input-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .chat-input-row input[type="text"] {
            flex: 1;
            border-radius: 10px;
            border: 1px solid #374151;
            padding: 8px 10px;
            font-size: 13px;
            background: #020617;
            color: var(--text-main);
        }
        .chat-input-row input::placeholder {
            color: #6b7280;
        }
        .chat-send-btn {
            background: #16a34a;
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 10px;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        .chat-send-btn:hover {
            background: #15803d;
        }
        .chat-attach {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            background: #020617;
            color: #e5e7eb;
        }
        .chat-attach:hover {
            background: #111827;
        }
        .chat-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        .msg {
            margin-bottom: 6px;
            line-height: 1.35;
        }
        .msg-you {
            text-align: right;
        }
        .msg-author {
            font-size: 11px;
            opacity: 0.7;
        }
        .msg-bubble {
            display: inline-block;
            margin-top: 1px;
            padding: 6px 9px;
            border-radius: 9px;
            background: #111827;
        }
        .msg-you .msg-bubble {
            background: #1d4ed8;
        }
        /* fullscreen –¥–ª—è –æ–∫–Ω–∞ —É—á–∏—Ç–µ–ª—è —É —É—á–µ–Ω–∏–∫–∞ */
        #remoteViewportStudent:fullscreen {
            background: #000;
            max-width: none;
            width: 100%;
            height: 100%;
        }
        #remoteViewportStudent:fullscreen video {
            object-fit: contain;
        }
        @media (max-width: 980px) {
            .card {
                width: 100%;
                margin: 6px;
                padding: 14px;
            }
            .bottom-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="card">
    <div class="top-row">
        <h2>–£—Ä–æ–∫ WebClass</h2>
        <div id="roomInfo" class="room"></div>
    </div>

    <div class="bottom-row">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –£–ß–ò–¢–ï–õ–¨ –î–õ–Ø –£–ß–ï–ù–ò–ö–ê -->
        <div class="video-column">
            <div class="video-title">–£—á–∏—Ç–µ–ª—å</div>
            <div class="video-sub" id="teacherNameLabel">‚Äî</div>
            <div class="viewport" id="remoteViewportStudent">
                <video id="remoteVideoStudent" autoplay playsinline muted></video>
                <div class="video-toolbar">
                    <button id="remoteFullscreenStudent" class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">‚§¢</button>
                    <button id="remoteMuteStudent" class="icon-btn" title="–í–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫">üîá</button>
                </div>
                <div class="video-placeholder" id="remotePlaceholderStudent">
                    <div>–û–∫–Ω–æ —É—á–∏—Ç–µ–ª—è</div>
                    <b>–£—á–∏—Ç–µ–ª—å</b>
                    <div>–ö–æ–≥–¥–∞ —É—á–∏—Ç–µ–ª—å –Ω–∞—á–Ω—ë—Ç —É—Ä–æ–∫, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –µ–≥–æ –≤–∏–¥–µ–æ.</div>
                </div>
            </div>
        </div>

        <!-- –¶–ï–ù–¢–†: –ß–ê–¢ -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-title">–ß–∞—Ç —É—Ä–æ–∫–∞</div>
                <div class="chat-status">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞ –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤—ã</div>
            </div>
            <div id="chatMessagesStudent" class="chat-messages">
                <div class="chat-empty">
                    –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —É—á–∏—Ç–µ–ª—é ‚Äî –ø–æ–∑–∂–µ –º—ã —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤–∏–¥–µ–ª —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
                </div>
            </div>
            <div class="chat-input-row">
                <label class="chat-attach" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    üìé
                    <input type="file" id="chatFileStudent" style="display:none;">
                </label>
                <input id="chatInputStudent" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—é...">
                <button id="chatSendStudent" class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <div class="chat-note">
                –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ 10 –ú–ë (PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –≠—Ç–æ –¥–µ–º–æ ‚Äî –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –£–ß–ï–ù–ò–ö (–°–ï–ë–Ø –í–ò–î–ò–¢) -->
        <div class="video-column">
            <div class="video-title">–í—ã (—É—á–µ–Ω–∏–∫)</div>
            <div class="video-sub">–ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
            <div class="viewport" id="localViewportStudent">
                <video id="localVideoStudent" autoplay playsinline muted></video>
                <div class="video-toolbar">
                    <button id="selfMuteStudent" class="icon-btn" title="–í–∫–ª/–≤—ã–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
                </div>
                <div class="video-placeholder" id="localPlaceholderStudent">
                    <div>–í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É...</div>
                    <div style="font-size:11px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
                </div>
            </div>
            <button class="chat-send-btn" style="margin-top:10px;" onclick="goHome()">–í—ã–π—Ç–∏ –∏–∑ —É—Ä–æ–∫–∞</button>
        </div>
    </div>
</div>

<script>

const params = new URLSearchParams(window.location.search);
const room = params.get("room") || "demo-room";
const teacherName = params.get("teacher") || "–£—á–∏—Ç–µ–ª—å";

const roomInfoEl = document.getElementById("roomInfo");
const teacherNameLabel = document.getElementById("teacherNameLabel");
if (roomInfoEl) roomInfoEl.textContent = "–ö–æ–º–Ω–∞—Ç–∞: " + room;
if (teacherNameLabel) teacherNameLabel.textContent = teacherName;

// ===== –ß–ê–¢ –£–ß–ï–ù–ò–ö–ê (–ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ) =====
const chatMessagesS = document.getElementById("chatMessagesStudent");
const chatInputS = document.getElementById("chatInputStudent");
const chatSendS = document.getElementById("chatSendStudent");
const chatFileS = document.getElementById("chatFileStudent");

function addStudentMessage(text, isFile = false) {
  if (!text || !text.trim() || !chatMessagesS) return;

  const empty = chatMessagesS.querySelector(".chat-empty");
  if (empty) empty.remove();

  const wrapper = document.createElement("div");
  wrapper.className = "msg msg-you";

  const author = document.createElement("div");
  author.className = "msg-author";
  author.textContent = isFile ? "–§–∞–π–ª (–¥–µ–º–æ)" : "–í—ã";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  bubble.textContent = text;

  wrapper.appendChild(author);
  wrapper.appendChild(bubble);
  chatMessagesS.appendChild(wrapper);

  chatMessagesS.scrollTop = chatMessagesS.scrollHeight;
}

if (chatSendS && chatInputS) {
  chatSendS.addEventListener("click", () => {
    addStudentMessage(chatInputS.value);
    chatInputS.value = "";
  });

  chatInputS.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addStudentMessage(chatInputS.value);
      chatInputS.value = "";
    }
  });
}

if (chatFileS) {
  chatFileS.addEventListener("change", () => {
    if (!chatFileS.files || chatFileS.files.length === 0) return;
    const file = chatFileS.files[0];
    addStudentMessage(`–§–∞–π–ª: ${file.name} (–¥–µ–º–æ)`, true);
    chatFileS.value = "";
  });
}

function goHome() {
  window.location.href = "/";
}
window.goHome = goHome; // —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ –∫–Ω–æ–ø–∫–∞

// ===== –õ–û–ö–ê–õ–¨–ù–û–ï –í–ò–î–ï–û –£–ß–ï–ù–ò–ö–ê =====
let localStreamStudent = null;
let isMicMutedStudent = false;

async function startLocalVideoStudent() {
  const previewVideo = document.getElementById("localVideoStudent");
  const placeholder = document.getElementById("localPlaceholderStudent");
  if (!previewVideo) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localStreamStudent = stream;
    previewVideo.srcObject = stream;
    previewVideo.muted = true; // —á—Ç–æ–±—ã —É —É—á–µ–Ω–∏–∫–∞ –Ω–µ —Ñ–æ–Ω–∏–ª–æ
    previewVideo.playsInline = true;
    if (placeholder) placeholder.style.display = "none";
    maybeAttachLocalTracksStudent();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —É—á–µ–Ω–∏–∫–∞:", err);
    if (placeholder) {
      placeholder.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.";
    }
  }
}

function toggleStudentMic() {
  if (!localStreamStudent) return;
  isMicMutedStudent = !isMicMutedStudent;
  localStreamStudent.getAudioTracks().forEach(t => t.enabled = !isMicMutedStudent);
  const btn = document.getElementById("selfMuteStudent");
  if (btn) btn.textContent = isMicMutedStudent ? "üé§‚úï" : "üé§";
}

// ===== –î–ò–°–¢–ê–ù–¶–ò–û–ù–ù–û–ï –í–ò–î–ï–û –£–ß–ò–¢–ï–õ–Ø (–∑–≤—É–∫ + fullscreen) =====
let isRemoteMutedStudent = false; // —É—á–µ–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–ª—ã—à–∏—Ç —É—á–∏—Ç–µ–ª—è

function toggleRemoteMuteStudent() {
  const video = document.getElementById("remoteVideoStudent");
  if (!video) return;
  isRemoteMutedStudent = !isRemoteMutedStudent;
  video.muted = isRemoteMutedStudent;
  const btn = document.getElementById("remoteMuteStudent");
  if (btn) btn.textContent = isRemoteMutedStudent ? "üîá" : "üîä";
}

function toggleFullscreen(el, btn) {
  if (!el) return;
  if (!document.fullscreenElement) {
    if (el.requestFullscreen) {
      el.requestFullscreen();
      if (btn) btn.textContent = "‚§°";
    }
  } else {
    document.exitFullscreen();
  }
}

document.addEventListener("fullscreenchange", () => {
  const btn = document.getElementById("remoteFullscreenStudent");
  if (!btn) return;
  if (!document.fullscreenElement) {
    btn.textContent = "‚§¢";
  }
});

// ===== WebRTC + WebSocket (—É—á–µ–Ω–∏–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç offer) =====
let wsStudent = null;
let pcStudent = null;

function createWebSocketStudent() {
  const proto = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${proto}://${window.location.host}/ws?room=${encodeURIComponent(room)}&role=student`;
  wsStudent = new WebSocket(wsUrl);

  wsStudent.onopen = () => {
    console.log("[student] WebSocket –æ—Ç–∫—Ä—ã—Ç");
  };

  wsStudent.onmessage = async (event) => {
    const msg = JSON.parse(event.data || "{}");
    const type = msg.type;
    console.log("[student] WS message:", msg);

    if (type === "both-ready") {
      // –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, –∂–¥—ë–º offer –æ—Ç —É—á–∏—Ç–µ–ª—è
    } else if (type === "offer") {
      const pc = ensurePeerConnectionStudent();
      const desc = new RTCSessionDescription(msg.sdp);
      await pc.setRemoteDescription(desc);
      console.log("[student] –ü–æ–ª—É—á–µ–Ω offer, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer");
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      wsStudent.send(JSON.stringify({
        type: "answer",
        sdp: answer
      }));
    } else if (type === "ice-candidate") {
      if (!pcStudent || !msg.candidate) return;
      try {
        await pcStudent.addIceCandidate(msg.candidate);
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ addIceCandidate (student):", e);
      }
    }
  };

  wsStudent.onclose = () => {
    console.log("[student] WebSocket –∑–∞–∫—Ä—ã—Ç");
  };

  wsStudent.onerror = (e) => {
    console.error("[student] WebSocket error:", e);
  };
}

function ensurePeerConnectionStudent() {
  if (pcStudent) return pcStudent;

  pcStudent = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  maybeAttachLocalTracksStudent();

  pcStudent.onicecandidate = (event) => {
    if (event.candidate && wsStudent && wsStudent.readyState === WebSocket.OPEN) {
      wsStudent.send(JSON.stringify({
        type: "ice-candidate",
        candidate: event.candidate
      }));
    }
  };

  pcStudent.ontrack = (event) => {
    const remoteVideo = document.getElementById("remoteVideoStudent");
    const placeholder = document.getElementById("remotePlaceholderStudent");
    if (remoteVideo && !remoteVideo.srcObject) {
      remoteVideo.srcObject = event.streams[0];
      remoteVideo.playsInline = true;
      remoteVideo.muted = isRemoteMutedStudent;
    }
    if (placeholder) placeholder.style.display = "none";
  };

  return pcStudent;
}

function maybeAttachLocalTracksStudent() {
  if (!localStreamStudent || !pcStudent) return;
  if (pcStudent.getSenders().length > 0) return; // —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏
  localStreamStudent.getTracks().forEach(track => {
    pcStudent.addTrack(track, localStreamStudent);
  });
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
window.addEventListener("DOMContentLoaded", () => {
  startLocalVideoStudent();
  createWebSocketStudent();

  const micBtn = document.getElementById("selfMuteStudent");
  if (micBtn) micBtn.addEventListener("click", toggleStudentMic);

  const remoteMuteBtn = document.getElementById("remoteMuteStudent");
  if (remoteMuteBtn) remoteMuteBtn.addEventListener("click", toggleRemoteMuteStudent);

  const fsBtn = document.getElementById("remoteFullscreenStudent");
  const remoteViewport = document.getElementById("remoteViewportStudent");
  if (fsBtn && remoteViewport) {
    fsBtn.addEventListener("click", () => toggleFullscreen(remoteViewport, fsBtn));
  }
});

</script>
</body>
</html>
