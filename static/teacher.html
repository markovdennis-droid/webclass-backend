<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WebClass ‚Äî –£—á–∏—Ç–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at center, #002040, #000814 80%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
      padding: 20px;
    }

    h1, h2 {
      font-weight: 600;
    }

    .top-card {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 16px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .top-card-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .link-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #student-link {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 13px;
    }

    .btn {
      background: #18c964;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #000;
      white-space: nowrap;
    }

    .container {
      display: flex;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }

    .column {
      width: 28vw;
      min-width: 300px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 15px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    .column h2 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 4px;
    }

    .video-box {
      width: 100%;
      aspect-ratio: 9 / 16;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
    }

    .chat {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .messages {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 10px;
      overflow-y: auto;
      font-size: 15px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
      font-size: 15px;
    }

    .attachments-hint {
      font-size: 12px;
      opacity: 0.7;
    }

  </style>
</head>

<body>

  <div class="top-card">
    <div class="top-card-row">
      <div><strong>–£—á–∏—Ç–µ–ª—å:</strong> <span id="teacherNameLabel"></span></div>
      <div><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> <span id="roomLabel"></span></div>
    </div>
    <div class="link-row">
      <input id="student-link" readonly>
      <button class="btn" onclick="copyStudentLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div style="font-size: 12px; opacity: 0.8;">
      –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫—É –≤ –ª—é–±–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.
    </div>
  </div>

  <div class="container">

    <!-- –£—á–∏—Ç–µ–ª—å -->
    <div class="column">
      <h2>–í—ã (—É—á–∏—Ç–µ–ª—å)</h2>
      <div id="teacherBox" class="video-box">
        <video id="teacherVideo" autoplay muted playsinline></video>
        <div class="video-controls">
          <button class="icon-btn" id="teacherMuteBtn" title="–í—ã–∫–ª/–≤–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">üîá</button>
          <button class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω" onclick="toggleFullscreen('teacherBox')">‚õ∂</button>
        </div>
      </div>
    </div>

    <!-- –ß–∞—Ç -->
    <div class="column">
      <h2>–ß–∞—Ç —É—Ä–æ–∫–∞</h2>
      <div class="chat">
        <div id="messages" class="messages">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.</div>
        <div class="input-row">
          <input id="msgInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
          <button class="btn" onclick="sendMessage()">OK</button>
        </div>
        <div class="attachments-hint">
          –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ 10 –ú–ë (PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.
        </div>
      </div>
    </div>

    <!-- –£—á–µ–Ω–∏–∫ -->
    <div class="column">
      <h2>–£—á–µ–Ω–∏–∫</h2>
      <div id="studentBox" class="video-box">
        <video id="studentVideo" autoplay playsinline></video>
        <div class="video-controls">
          <button class="icon-btn" id="studentMuteBtn" title="–í—ã–∫–ª/–≤–∫–ª –∑–≤—É–∫ —É—á–µ–Ω–∏–∫–∞">üîà</button>
          <button class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω" onclick="toggleFullscreen('studentBox')">‚õ∂</button>
        </div>
      </div>
    </div>

  </div>

<script>
////////////////////////////////////////////////////////////////////////////////
// –ü–ê–†–ê–ú–ï–¢–†–´ URL
////////////////////////////////////////////////////////////////////////////////
const params = new URLSearchParams(window.location.search);
const room = params.get("room") || "room1";
const teacherName = params.get("name") || "–£—á–∏—Ç–µ–ª—å";

document.getElementById("teacherNameLabel").textContent = teacherName;
document.getElementById("roomLabel").textContent = room;

// –°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ
function updateStudentLink() {
  const origin = window.location.origin;
  const link = `${origin}/student?room=${encodeURIComponent(room)}&teacher=${encodeURIComponent(teacherName)}`;
  document.getElementById("student-link").value = link;
}
updateStudentLink();

function copyStudentLink() {
  const inp = document.getElementById("student-link");
  inp.select();
  inp.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(inp.value).then(() => {
    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
  }).catch(() => {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.");
  });
}

////////////////////////////////////////////////////////////////////////////////
// –õ–û–ö–ê–õ–¨–ù–û–ï –í–ò–î–ï–û –£–ß–ò–¢–ï–õ–Ø
////////////////////////////////////////////////////////////////////////////////
let localStream = null;
const teacherVideo = document.getElementById("teacherVideo");
const teacherMuteBtn = document.getElementById("teacherMuteBtn");
let teacherMuted = false;

async function startLocalVideo() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    teacherVideo.srcObject = localStream;
  } catch (err) {
    console.error(err);
    alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
  }
}
startLocalVideo();

teacherMuteBtn.addEventListener("click", () => {
  if (!localStream) return;
  teacherMuted = !teacherMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !teacherMuted);
  teacherMuteBtn.textContent = teacherMuted ? "üîà" : "üîá";
});

function toggleFullscreen(boxId) {
  const el = document.getElementById(boxId);
  if (!el) return;
  if (document.fullscreenElement) {
    document.exitFullscreen().catch(() => {});
  } else {
    el.requestFullscreen().catch(() => {});
  }
}

////////////////////////////////////////////////////////////////////////////////
// WebRTC + WebSocket
////////////////////////////////////////////////////////////////////////////////
const wsProto = location.protocol === "https:" ? "wss" : "ws";
const wsURL = "wss://webclass-backend-g3uh.onrender.com/ws";
const ws = new WebSocket(wsURL);

let pc = null;
const studentVideo = document.getElementById("studentVideo");

function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  if (localStream) {
    localStream.getTracks().forEach(track => {
      pc.addTrack(track, localStream);
    });
  }

  pc.ontrack = (event) => {
    studentVideo.srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(JSON.stringify({
        type: "ice-candidate",
        candidate: event.candidate
      }));
    }
  };
}

ws.onmessage = async (ev) => {
  const msg = JSON.parse(ev.data);

  if (msg.type === "both-ready") {
    if (!pc) createPeerConnection();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    ws.send(JSON.stringify({
      type: "offer",
      sdp: pc.localDescription
    }));
  }

  if (msg.type === "answer" && pc) {
    const remoteDesc = new RTCSessionDescription(msg.sdp);
    await pc.setRemoteDescription(remoteDesc);
  }

  if (msg.type === "ice-candidate" && pc && msg.candidate) {
    try {
      await pc.addIceCandidate(msg.candidate);
    } catch (err) {
      console.error("ICE error", err);
    }
  }
};

////////////////////////////////////////////////////////////////////////////////
// –ß–ê–¢ (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π UI)
////////////////////////////////////////////////////////////////////////////////
function sendMessage() {
  const box = document.getElementById("msgInput");
  const text = box.value.trim();
  if (!text) return;

  const container = document.getElementById("messages");
  if (container.textContent === "–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.") container.innerHTML = "";

  const div = document.createElement("div");
  div.textContent = "–í—ã: " + text;
  container.appendChild(div);

  box.value = "";
}
</script>

</body>
</html>
