<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Ученик — WebClass</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#0b1220; color:#fff;
  font-family:-apple-system, BlinkMacSystemFont, Roboto, sans-serif;
  padding:20px;
}

.wrapper { display:flex; gap:20px; }

.col {
  flex:1;
  background:#131a2a;
  padding:15px;
  border-radius:12px;
}

video {
  width:100%; background:#000;
  border-radius:10px;
}

#chat {
  height:380px; background:#0d1320;
  overflow-y:auto; padding:10px;
  border-radius:10px;
}

input,button {
  padding:10px;
  border-radius:8px;
  border:none;
  margin-top:5px;
}

button {
  background:#32d27f;
  cursor:pointer;
}
</style>
</head>

<body>
<h2>Ученик</h2>

<div class="wrapper">
  <div class="col">
    <h3>Ваше видео</h3>
    <video id="local" autoplay playsinline muted></video>
  </div>

  <div class="col">
    <h3>Учитель</h3>
    <video id="remote" autoplay playsinline></video>
  </div>

  <div class="col">
    <h3>Чат</h3>
    <div id="chat"></div>
    <input id="msg"><button onclick="sendMsg()">OK</button>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const room   = params.get("room") || "room1";

const wsURL  = "wss://" + window.location.host + "/ws?room=" + room + "&role=student";
const ws     = new WebSocket(wsURL);

let pc = new RTCPeerConnection({
 iceServers: [
   { urls: "stun:stun.l.google.com:19302" },
   {
     urls: "turn:global.turn.twilio.com:3478?transport=tcp",
     username: "demo",
     credential: "demo"
   }
 ]
});

pc.onicecandidate = e => {
  if (e.candidate) ws.send(JSON.stringify({ type:"ice", candidate:e.candidate }));
};

pc.ontrack = e => {
  document.getElementById("remote").srcObject = e.streams[0];
};

(async () => {
  let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  document.getElementById("local").srcObject = stream;
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify(offer));
})();

ws.onmessage = async e => {
  let msg = JSON.parse(e.data);

  if (msg.chat)
    chat.innerHTML += `<div><b>Учитель:</b> ${msg.chat}</div>`;

  if (msg.type === "answer")
    await pc.setRemoteDescription(msg);

  if (msg.type === "ice")
    pc.addIceCandidate(msg.candidate);
};

function sendMsg() {
  let m = msg.value;
  ws.send(JSON.stringify({ chat:m }));
  chat.innerHTML += `<div><b>Вы:</b> ${m}</div>`;
  msg.value = "";
}
</script>

</body>
</html>
