<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebClass ‚Äî –£—á–∏—Ç–µ–ª—å</title>
    <style>
        :root {
            --bg-grad: linear-gradient(145deg, #020617 0%, #0b1635 45%, #020617 100%);
            --panel: rgba(15,23,42,0.96);
            --panel-soft: rgba(15,23,42,0.9);
            --border: #1e293b;
            --accent: #4f46e5;
            --accent-soft: rgba(79,70,229,0.2);
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-grad);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
        }

        .container {
            background: radial-gradient(circle at top left, #020617 0%, #020617 55%, #000 100%);
            padding: 20px 22px 24px;
            border-radius: 22px;
            box-shadow: 0 26px 60px rgba(0,0,0,0.6);
            width: 1400px;
            max-width: 98vw;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */

        .top-row {
            display: flex;
            gap: 18px;
            align-items: flex-start;
        }

        .link-block {
            flex: 1.6;
            background: var(--panel);
            border-radius: 16px;
            padding: 12px 14px 12px;
            border: 1px solid rgba(148,163,184,0.28);
        }

        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .link-title {
            font-size: 16px;
            font-weight: 600;
        }

        .link-toggle {
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            border: none;
            background: transparent;
            padding: 3px 7px;
            border-radius: 999px;
        }

        .link-toggle:hover {
            background: rgba(148,163,184,0.18);
        }

        .room-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .link-content.hidden {
            display: none;
        }

        .link-input-row {
            display: flex;
            gap: 8px;
        }

        input[type="text"] {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            font-size: 13px;
            background: #020617;
            color: var(--text-main);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent-soft);
        }

        .btn {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            background-color: var(--accent);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: background .15s, transform .05s;
        }

        .btn:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }

        .hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 3px;
        }

        .teacher-info {
            flex: 1;
            font-size: 13px;
            color: var(--text-muted);
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--panel-soft);
        }

        .teacher-info b {
            color: var(--text-main);
        }

        /* –Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å: —Ç—Ä–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –±–ª–æ–∫–∞ */

        .bottom-row {
            display: grid;
            grid-template-columns: minmax(0, 1.35fr) minmax(0, 1.3fr) minmax(0, 1.35fr);
            gap: 14px;
            align-items: stretch;
        }

        .video-column {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
            min-height: 340px;
        }

        .video-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .video-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .viewport {
            flex: 1;
            border-radius: 14px;
            background: radial-gradient(circle at top, #020617 0%, #000 100%);
            border: 1px solid rgba(30,64,175,0.7);
            position: relative;
            overflow: hidden;
            /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–∞–∫ —Ç–µ–ª–µ—Ñ–æ–Ω */
            aspect-ratio: 9 / 16;
            align-self: center;
            width: 100%;
            max-width: min(33vw, 520px);
        }

        .viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* –∑–∞–ø–æ–ª–Ω—è–µ–º –±–ª–æ–∫ –∫–∞–∫ 1080x1920, –º–æ–∂–Ω–æ —Å –æ–±—Ä–µ–∑–∫–æ–π */
            background: #000;
            display: block;
        }

        .video-toolbar {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .icon-btn {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.45);
            background: rgba(15,23,42,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--text-main);
        }

        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 0 12px;
            pointer-events: none;
        }

        .video-placeholder b {
            font-size: 16px;
            color: var(--text-main);
        }

        /* –ß–ê–¢ –ü–û –°–ï–†–ï–î–ò–ù–ï */

        .chat-panel {
            background: var(--panel);
            border-radius: 18px;
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 16px 40px rgba(0,0,0,0.55);
            min-height: 340px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chat-title {
            font-size: 14px;
            font-weight: 500;
        }

        .chat-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        .chat-messages {
            flex: 1;
            background: #020617;
            border-radius: 10px;
            border: 1px solid #111827;
            padding: 8px;
            overflow-y: auto;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .chat-empty {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 18px;
        }

        .chat-input-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-input-row input[type="text"] {
            flex: 1;
            border-radius: 10px;
            border: 1px solid #374151;
            padding: 8px 10px;
            font-size: 13px;
            background: #020617;
            color: var(--text-main);
        }

        .chat-input-row input::placeholder {
            color: #6b7280;
        }

        .chat-send-btn {
            background: #16a34a;
            font-size: 13px;
            padding: 8px 10px;
        }

        .chat-send-btn:hover {
            background: #15803d;
        }

        .chat-attach {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            background: #020617;
            color: #e5e7eb;
        }

        .chat-attach:hover {
            background: #111827;
        }

        .chat-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .msg {
            margin-bottom: 6px;
            line-height: 1.35;
        }

        .msg-you {
            text-align: right;
        }

        .msg-author {
            font-size: 11px;
            opacity: 0.7;
        }

        .msg-bubble {
            display: inline-block;
            margin-top: 1px;
            padding: 6px 9px;
            border-radius: 9px;
            background: #111827;
        }

        .msg-you .msg-bubble {
            background: #1d4ed8;
        }

        /* fullscreen —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ (—É—á–µ–Ω–∏–∫) –æ–∫–Ω–∞ */
        #remoteViewportTeacher:fullscreen {
            background: #000;
            max-width: none;
            width: 100%;
            height: 100%;
        }
        #remoteViewportTeacher:fullscreen video {
            object-fit: contain;
        }

        @media (max-width: 980px) {
            .container {
                width: 100%;
                margin: 6px;
                padding: 14px;
            }
            .top-row {
                flex-direction: column;
            }
            .bottom-row {
                grid-template-columns: 1fr;
            }
            .viewport {
                max-width: 260px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="top-row">
        <div class="link-block">
            <div class="link-header">
                <div class="link-title">–°—Å—ã–ª–∫–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</div>
                <button id="toggleLink" class="link-toggle">–°–≤–µ—Ä–Ω—É—Ç—å</button>
            </div>
            <div id="roomInfo" class="room-label"></div>
            <div id="linkContent" class="link-content">
                <div class="link-input-row">
                    <input id="lessonLink" type="text" readonly>
                    <button id="copyBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="hint">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë —É—á–µ–Ω–∏–∫—É –≤ –ª—é–±–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.</div>
            </div>
        </div>
        <div class="teacher-info">
            <div><b>–£—á–∏—Ç–µ–ª—å:</b> <span id="teacherNameLabel">‚Äî</span></div>
            <div><b>–ö–æ–º–Ω–∞—Ç–∞:</b> <span id="roomShort">‚Äî</span></div>
            <div style="margin-top:6px;">
                –°–ª–µ–≤–∞ ‚Äî –≤–∞—à–µ –≤–∏–¥–µ–æ, —Å–ø—Ä–∞–≤–∞ ‚Äî –æ–∫–Ω–æ —É—á–µ–Ω–∏–∫–∞. –í —Ü–µ–Ω—Ç—Ä–µ ‚Äî —á–∞—Ç —É—Ä–æ–∫–∞.
                –ü–æ–∑–∂–µ —Å—é–¥–∞ –¥–æ–±–∞–≤–∏–º –æ–±—â–µ–µ –≤–∏–¥–µ–æ-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
            </div>
        </div>
    </div>

    <div class="bottom-row">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –£–ß–ò–¢–ï–õ–¨ -->
        <div class="video-column">
            <div class="video-title">–í—ã (—É—á–∏—Ç–µ–ª—å)</div>
            <div class="video-sub">–ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
            <div class="viewport" id="localViewportTeacher">
                <video id="localVideoTeacher" autoplay playsinline muted></video>
                <div class="video-toolbar">
                    <button id="selfMuteTeacher" class="icon-btn" title="–í–∫–ª/–≤—ã–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
                </div>
                <div class="video-placeholder" id="localPlaceholderTeacher">
                    <div>–í–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É...</div>
                    <div style="font-size:11px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
                </div>
            </div>
        </div>

        <!-- –¶–ï–ù–¢–†: –ß–ê–¢ -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-title">–ß–∞—Ç —É—Ä–æ–∫–∞</div>
                <div class="chat-status">–ü–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤—ã</div>
            </div>
            <div id="chatMessagesTeacher" class="chat-messages">
                <div class="chat-empty">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —É—á–µ–Ω–∏–∫—É.</div>
            </div>
            <div class="chat-input-row">
                <label class="chat-attach" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    üìé
                    <input type="file" id="chatFileTeacher" style="display:none;">
                </label>
                <input id="chatInputTeacher" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="chatSendTeacher" class="btn chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <div class="chat-note">
                –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ 10 –ú–ë (PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –£–ß–ï–ù–ò–ö -->
        <div class="video-column">
            <div class="video-title">–û–∫–Ω–æ —É—á–µ–Ω–∏–∫–∞</div>
            <div class="video-sub">–ö–æ–≥–¥–∞ —É—á–µ–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –µ–≥–æ –≤–∏–¥–µ–æ</div>
            <div class="viewport" id="remoteViewportTeacher">
                <video id="remoteVideoTeacher" autoplay playsinline muted></video>
                <div class="video-toolbar">
                    <button id="remoteFullscreenTeacher" class="icon-btn" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">‚§¢</button>
                    <button id="remoteMuteTeacher" class="icon-btn" title="–í–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫">üîá</button>
                </div>
                <div class="video-placeholder" id="remotePlaceholderTeacher">
                    <div>–û–∫–Ω–æ —É—á–µ–Ω–∏–∫–∞</div>
                    <b id="remoteNameLabel">–£—á–µ–Ω–∏–∫</b>
                    <div>–ö–æ–≥–¥–∞ —É—á–µ–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è, –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –µ–≥–æ –≤–∏–¥–µ–æ.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

const params = new URLSearchParams(window.location.search);
const room = params.get("room") || "demo-room";
const name = params.get("name") || "–£—á–∏—Ç–µ–ª—å";

const studentLink = `${window.location.origin}/student.html?room=${encodeURIComponent(room)}&teacher=${encodeURIComponent(name)}`;

// ===== –°–°–´–õ–ö–ê –î–õ–Ø –£–ß–ï–ù–ò–ö–ê / –®–ê–ü–ö–ê =====
const lessonLinkInput = document.getElementById("lessonLink");
const copyBtn = document.getElementById("copyBtn");
const roomInfoEl = document.getElementById("roomInfo");
const teacherNameLabel = document.getElementById("teacherNameLabel");
const roomShort = document.getElementById("roomShort");
const remoteNameLabel = document.getElementById("remoteNameLabel");

if (lessonLinkInput) lessonLinkInput.value = studentLink;
if (roomInfoEl) roomInfoEl.textContent = "–ö–æ–º–Ω–∞—Ç–∞: " + room;
if (teacherNameLabel) teacherNameLabel.textContent = name;
if (roomShort) roomShort.textContent = room;
if (remoteNameLabel) remoteNameLabel.textContent = "–£—á–µ–Ω–∏–∫";

if (copyBtn) {
  copyBtn.addEventListener("click", () => {
    navigator.clipboard.writeText(studentLink).then(() => {
      copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì";
      copyBtn.style.backgroundColor = "#22c55e";
      setTimeout(() => {
        copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
        copyBtn.style.backgroundColor = "#4f46e5";
      }, 2000);
    });
  });
}

const toggleBtn = document.getElementById("toggleLink");
const linkContent = document.getElementById("linkContent");
if (toggleBtn && linkContent) {
  toggleBtn.addEventListener("click", () => {
    linkContent.classList.toggle("hidden");
    toggleBtn.textContent = linkContent.classList.contains("hidden") ? "–ü–æ–∫–∞–∑–∞—Ç—å" : "–°–≤–µ—Ä–Ω—É—Ç—å";
  });
}

// ===== –ß–ê–¢ –£–ß–ò–¢–ï–õ–Ø (–¥–µ–º–æ –ª–æ–∫–∞–ª—å–Ω—ã–π) =====
const chatMessagesT = document.getElementById("chatMessagesTeacher");
const chatInputT = document.getElementById("chatInputTeacher");
const chatSendT = document.getElementById("chatSendTeacher");
const chatFileT = document.getElementById("chatFileTeacher");

function addTeacherMessage(text, isFile = false) {
  if (!text || !text.trim() || !chatMessagesT) return;
  const empty = chatMessagesT.querySelector(".chat-empty");
  if (empty) empty.remove();

  const wrapper = document.createElement("div");
  wrapper.className = "msg msg-you";

  const author = document.createElement("div");
  author.className = "msg-author";
  author.textContent = isFile ? "–§–∞–π–ª (–¥–µ–º–æ)" : "–í—ã";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble";
  bubble.textContent = text;

  wrapper.appendChild(author);
  wrapper.appendChild(bubble);
  chatMessagesT.appendChild(wrapper);
  chatMessagesT.scrollTop = chatMessagesT.scrollHeight;
}

if (chatSendT && chatInputT) {
  chatSendT.addEventListener("click", () => {
    addTeacherMessage(chatInputT.value);
    chatInputT.value = "";
    chatInputT.focus();
  });

  chatInputT.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addTeacherMessage(chatInputT.value);
      chatInputT.value = "";
    }
  });
}

if (chatFileT) {
  chatFileT.addEventListener("change", () => {
    if (!chatFileT.files || chatFileT.files.length === 0) return;
    const file = chatFileT.files[0];
    addTeacherMessage(`–§–∞–π–ª: ${file.name} (–¥–æ 10 –ú–ë, –¥–µ–º–æ)`, true);
    chatFileT.value = "";
  });
}

// ===== –õ–û–ö–ê–õ–¨–ù–û–ï –í–ò–î–ï–û –£–ß–ò–¢–ï–õ–Ø =====
let localStreamTeacher = null;
let isMicMutedTeacher = false;

async function startLocalVideoTeacher() {
  const video = document.getElementById("localVideoTeacher");
  const placeholder = document.getElementById("localPlaceholderTeacher");
  if (!video) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localStreamTeacher = stream;
    video.srcObject = stream;
    video.muted = true;
    video.playsInline = true;
    if (placeholder) placeholder.style.display = "none";
    tryStartOffer(); // –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å WebRTC, –µ—Å–ª–∏ –≤—Å—ë –≥–æ—Ç–æ–≤–æ
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —É—á–∏—Ç–µ–ª—è:", err);
    if (placeholder) {
      placeholder.innerHTML = "<div>–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É.</div><div style='font-size:11px;'>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.</div>";
    }
  }
}

function toggleTeacherMic() {
  if (!localStreamTeacher) return;
  isMicMutedTeacher = !isMicMutedTeacher;
  localStreamTeacher.getAudioTracks().forEach(t => t.enabled = !isMicMutedTeacher);
  const btn = document.getElementById("selfMuteTeacher");
  if (btn) btn.textContent = isMicMutedTeacher ? "üé§‚úï" : "üé§";
}

// ===== –î–ò–°–¢–ê–ù–¶–ò–û–ù–ù–û–ï –í–ò–î–ï–û –£–ß–ï–ù–ò–ö–ê (–∑–≤—É–∫ + fullscreen) =====
let isRemoteMutedTeacher = true;

function toggleRemoteMuteTeacher() {
  const video = document.getElementById("remoteVideoTeacher");
  if (!video) return;
  isRemoteMutedTeacher = !isRemoteMutedTeacher;
  video.muted = isRemoteMutedTeacher;
  const btn = document.getElementById("remoteMuteTeacher");
  if (btn) btn.textContent = isRemoteMutedTeacher ? "üîá" : "üîä";
}

function toggleFullscreen(el, btn) {
  if (!el) return;
  if (!document.fullscreenElement) {
    if (el.requestFullscreen) {
      el.requestFullscreen();
      if (btn) btn.textContent = "‚§°";
    }
  } else {
    document.exitFullscreen();
  }
}

document.addEventListener("fullscreenchange", () => {
  const btn = document.getElementById("remoteFullscreenTeacher");
  if (!btn) return;
  if (!document.fullscreenElement) {
    btn.textContent = "‚§¢";
  }
});

// ===== WebRTC + WebSocket —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ (—É—á–∏—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä) =====
let wsTeacher = null;
let pcTeacher = null;
let wsReady = false;
let bothReady = false;
let offerSent = false;

function createWebSocketTeacher() {
  const proto = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${proto}://${window.location.host}/ws?room=${encodeURIComponent(room)}&role=teacher`;
  wsTeacher = new WebSocket(wsUrl);

  wsTeacher.onopen = () => {
    wsReady = true;
    console.log("[teacher] WebSocket –æ—Ç–∫—Ä—ã—Ç");
    // —Å–µ—Ä–≤–µ—Ä —Å–∞–º –ø—Ä–∏—à–ª—ë—Ç both-ready, –∫–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è —É—á–µ–Ω–∏–∫
  };

  wsTeacher.onmessage = async (event) => {
    const msg = JSON.parse(event.data || "{}");
    const type = msg.type;
    console.log("[teacher] WS message:", msg);

    if (type === "both-ready") {
      bothReady = true;
      tryStartOffer();
    } else if (type === "answer") {
      if (!pcTeacher) return;
      const desc = new RTCSessionDescription(msg.sdp);
      await pcTeacher.setRemoteDescription(desc);
      console.log("[teacher] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω remote answer");
    } else if (type === "ice-candidate") {
      if (!pcTeacher || !msg.candidate) return;
      try {
        await pcTeacher.addIceCandidate(msg.candidate);
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ addIceCandidate (teacher):", e);
      }
    }
  };

  wsTeacher.onclose = () => {
    console.log("[teacher] WebSocket –∑–∞–∫—Ä—ã—Ç");
    wsReady = false;
  };

  wsTeacher.onerror = (e) => {
    console.error("[teacher] WebSocket error:", e);
  };
}

function ensurePeerConnectionTeacher() {
  if (pcTeacher) return pcTeacher;

  pcTeacher = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  if (localStreamTeacher) {
    localStreamTeacher.getTracks().forEach(track => {
      pcTeacher.addTrack(track, localStreamTeacher);
    });
  }

  pcTeacher.onicecandidate = (event) => {
    if (event.candidate && wsTeacher && wsTeacher.readyState === WebSocket.OPEN) {
      wsTeacher.send(JSON.stringify({
        type: "ice-candidate",
        candidate: event.candidate
      }));
    }
  };

  pcTeacher.ontrack = (event) => {
    const remoteVideo = document.getElementById("remoteVideoTeacher");
    const placeholder = document.getElementById("remotePlaceholderTeacher");
    if (remoteVideo && !remoteVideo.srcObject) {
      remoteVideo.srcObject = event.streams[0];
      remoteVideo.playsInline = true;
      remoteVideo.muted = isRemoteMutedTeacher; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–≤—É–∫ –≤—ã–∫–ª
    }
    if (placeholder) placeholder.style.display = "none";
  };

  return pcTeacher;
}

async function tryStartOffer() {
  if (offerSent) return;
  if (!wsReady || !bothReady || !localStreamTeacher) {
    return;
  }
  const pc = ensurePeerConnectionTeacher();
  try {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    if (wsTeacher && wsTeacher.readyState === WebSocket.OPEN) {
      wsTeacher.send(JSON.stringify({
        type: "offer",
        sdp: offer
      }));
      offerSent = true;
      console.log("[teacher] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω offer");
    }
  } catch (err) {
    console.error("[teacher] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ offer:", err);
  }
}

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
window.addEventListener("DOMContentLoaded", () => {
  startLocalVideoTeacher();
  createWebSocketTeacher();

  const micBtn = document.getElementById("selfMuteTeacher");
  if (micBtn) micBtn.addEventListener("click", toggleTeacherMic);

  const remoteMuteBtn = document.getElementById("remoteMuteTeacher");
  if (remoteMuteBtn) remoteMuteBtn.addEventListener("click", toggleRemoteMuteTeacher);

  const fsBtn = document.getElementById("remoteFullscreenTeacher");
  const remoteViewport = document.getElementById("remoteViewportTeacher");
  if (fsBtn && remoteViewport) {
    fsBtn.addEventListener("click", () => toggleFullscreen(remoteViewport, fsBtn));
  }
});

</script>
</body>
</html>
